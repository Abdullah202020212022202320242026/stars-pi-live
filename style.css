const Pi = window.Pi;

async function sendGift(giftId, totalAmount) {
  const appShare = (totalAmount * 0.40).toFixed(2);  // 40%
  const streamerShare = (totalAmount * 0.60).toFixed(2);  // 60%

  try {
    const payment = await Pi.createPayment({
      amount: totalAmount.toString(),
      memo: `Gift: ${giftId}`,
      metadata: {
        giftId: giftId,
        appShare,
        streamerShare
      }
    });

    payment.onReadyForServerApproval((paymentId) => {
      console.log("ğŸ” Ready for approval:", paymentId);
      // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ paymentId Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ù‡Ù†Ø§ Ø¥Ù† Ø£Ø±Ø¯Øª
    });

    payment.onReadyForServerCompletion((paymentId, txid) => {
      console.log("âœ… Payment completed:", txid);
      showGiftAnimation(giftId);
      alert(`ğŸ‰ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©! 
      
      ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒØ§Ù…Ù„: ${totalAmount} Pi
      ğŸ¤ Ù„Ù„Ù…Ø°ÙŠØ¹: ${streamerShare} Pi
      ğŸ›ï¸ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚: ${appShare} Pi`);
    });

    payment.onCancel(() => {
      alert("âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
    });

    payment.onError((error) => {
      console.error("ğŸš¨ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹:", error);
      alert("ğŸš¨ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹.");
    });

  } catch (error) {
    console.error("ğŸš¨ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹:", error);
    alert("â— ØªØ¹Ø°Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙØ¹. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Pi Network.");
  }
}

function showGiftAnimation(giftId) {
  const area = document.getElementById('animation-area');
  area.innerHTML = "";

  const img = document.createElement('img');
  img.src = getGiftImage(giftId);
  img.alt = giftId;
  img.style.width = "150px";
  img.style.animation = "bounce 2s infinite";
  area.appendChild(img);
}

function getGiftImage(giftId) {
  switch (giftId) {
    case "pyramids":
      return "https://upload.wikimedia.org/wikipedia/commons/e/e3/Kheops-Pyramid.jpg";
    case "tower":
      return "https://upload.wikimedia.org/wikipedia/commons/a/af/Tour_Eiffel_Wikimedia_Commons.jpg";
    case "flower":
      return "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/Garden_rose.jpg/800px-Garden_rose.jpg";
    default:
      return "";
  }
}
